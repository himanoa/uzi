<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Support for access to a write only value of a particular type.</span><span>
</span><span id="line-2"></span><span class="hs-comment">--</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- The value is thread local. If you want it to be shared between threads, use</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- &quot;Effectful.Writer.Static.Shared&quot;.</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- /Warning:/ 'Writer'\'s state will be accumulated via __left-associated__ uses</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- of '&lt;&gt;', which makes it unsuitable for use with types for which such pattern</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- is inefficient. __This applies, in particular, to the standard list type__,</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- which makes the 'Writer' effect pretty niche.</span><span>
</span><span id="line-10"></span><span class="hs-comment">--</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- /Note:/ while the 'Control.Monad.Trans.Writer.Strict.Writer' from the</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- @transformers@ package includes additional operations</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- 'Control.Monad.Trans.Writer.Strict.pass' and</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- 'Control.Monad.Trans.Writer.Strict.censor', they don't cooperate with runtime</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- exceptions very well, so they're deliberately omitted here.</span><span>
</span><span id="line-16"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Effectful.Writer.Static.Local</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Effect</span></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier">Writer</span></a></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Handlers</span></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#runWriter"><span class="hs-identifier">runWriter</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#execWriter"><span class="hs-identifier">execWriter</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Operations</span></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#tell"><span class="hs-identifier">tell</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#listen"><span class="hs-identifier">listen</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#listens"><span class="hs-identifier">listens</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">onException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mask</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Effectful.html"><span class="hs-identifier">Effectful</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Effectful.Dispatch.Static.html"><span class="hs-identifier">Effectful.Dispatch.Static</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Effectful.Dispatch.Static.Primitive.html"><span class="hs-identifier">Effectful.Dispatch.Static.Primitive</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-comment">-- | Provide access to a strict (WHNF), thread local, write only value of type</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- @w@.</span><span>
</span><span id="line-38"></span><span class="hs-keyword">data</span><span> </span><span id="Writer"><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span></span><span> </span><span id="local-6989586621679079425"><span class="annot"><a href="#local-6989586621679079425"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Effectful.Internal.Effect.html#Effect"><span class="hs-identifier hs-type">Effect</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="DispatchOf"><span class="annot"><a href="Effectful.Internal.Env.html#DispatchOf"><span class="hs-identifier hs-var">DispatchOf</span></a></span></span><span> </span><span id="local-6989586621679079427"><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079427"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Effectful.Internal.Env.html#Static"><span class="hs-identifier hs-type">Static</span></a></span><span> </span><span class="annot"><a href="Effectful.Internal.Env.html#NoSideEffects"><span class="hs-identifier hs-type">NoSideEffects</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StaticRep"><span class="annot"><a href="Effectful.Internal.Monad.html#StaticRep"><span class="hs-identifier hs-var">StaticRep</span></a></span></span><span> </span><span id="local-6989586621679079358"><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079358"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Writer"><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679079358"><span class="hs-identifier hs-type">w</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">-- | Run a 'Writer' effect and return the final value along with the final</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- output.</span><span>
</span><span id="line-45"></span><span id="local-6989586621679079333"><span id="local-6989586621679079335"><span id="local-6989586621679079336"><span class="annot"><a href="Effectful.Writer.Static.Local.html#runWriter"><span class="hs-identifier hs-type">runWriter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679079333"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079333"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679079335"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679079336"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079335"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679079336"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679079333"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-46"></span><span id="runWriter"><span class="annot"><span class="annottext">runWriter :: forall w (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
Monoid w =&gt;
Eff (Writer w : es) a -&gt; Eff es (a, w)
</span><a href="Effectful.Writer.Static.Local.html#runWriter"><span class="hs-identifier hs-var hs-var">runWriter</span></a></span></span><span> </span><span id="local-6989586621679079438"><span class="annot"><span class="annottext">Eff (Writer w : es) a
</span><a href="#local-6989586621679079438"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679079439"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079439"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span id="local-6989586621679079440"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079440"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StaticRep (Writer w)
-&gt; Eff (Writer w : es) a -&gt; Eff es (a, StaticRep (Writer w))
forall (e :: (Type -&gt; Type) -&gt; Type -&gt; Type)
       (sideEffects :: SideEffects)
       (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(DispatchOf e ~ 'Static sideEffects, MaybeIOE sideEffects es) =&gt;
StaticRep e -&gt; Eff (e : es) a -&gt; Eff es (a, StaticRep e)
</span><a href="Effectful.Internal.Monad.html#runStaticRep"><span class="hs-identifier hs-var">runStaticRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">w -&gt; StaticRep (Writer w)
forall w. w -&gt; StaticRep (Writer w)
</span><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span><span> </span><span class="annot"><span class="annottext">w
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Eff (Writer w : es) a
</span><a href="#local-6989586621679079438"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="annottext">(a, w) -&gt; Eff es (a, w)
forall a. a -&gt; Eff es a
forall (f :: Type -&gt; Type) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079439"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079440"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | Run a 'Writer' effect and return the final output, discarding the final</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- value.</span><span>
</span><span id="line-52"></span><span id="local-6989586621679079362"><span id="local-6989586621679079363"><span id="local-6989586621679079364"><span class="annot"><a href="Effectful.Writer.Static.Local.html#execWriter"><span class="hs-identifier hs-type">execWriter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679079362"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079362"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="#local-6989586621679079363"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679079364"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079363"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079362"><span class="hs-identifier hs-type">w</span></a></span></span></span></span><span>
</span><span id="line-53"></span><span id="execWriter"><span class="annot"><span class="annottext">execWriter :: forall w (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
Monoid w =&gt;
Eff (Writer w : es) a -&gt; Eff es w
</span><a href="Effectful.Writer.Static.Local.html#execWriter"><span class="hs-identifier hs-var hs-var">execWriter</span></a></span></span><span> </span><span id="local-6989586621679079450"><span class="annot"><span class="annottext">Eff (Writer w : es) a
</span><a href="#local-6989586621679079450"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span id="local-6989586621679079451"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079451"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StaticRep (Writer w)
-&gt; Eff (Writer w : es) a -&gt; Eff es (StaticRep (Writer w))
forall (e :: (Type -&gt; Type) -&gt; Type -&gt; Type)
       (sideEffects :: SideEffects)
       (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(DispatchOf e ~ 'Static sideEffects, MaybeIOE sideEffects es) =&gt;
StaticRep e -&gt; Eff (e : es) a -&gt; Eff es (StaticRep e)
</span><a href="Effectful.Internal.Monad.html#execStaticRep"><span class="hs-identifier hs-var">execStaticRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">w -&gt; StaticRep (Writer w)
forall w. w -&gt; StaticRep (Writer w)
</span><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span><span> </span><span class="annot"><span class="annottext">w
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Eff (Writer w : es) a
</span><a href="#local-6989586621679079450"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="annottext">w -&gt; Eff es w
forall a. a -&gt; Eff es a
forall (f :: Type -&gt; Type) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079451"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="annot"><span class="hs-comment">-- | Append the given output to the overall output of the 'Writer'.</span></span><span>
</span><span id="line-58"></span><span id="local-6989586621679079372"><span id="local-6989586621679079373"><span class="annot"><a href="Effectful.Writer.Static.Local.html#tell"><span class="hs-identifier hs-type">tell</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079372"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="Effectful.Internal.Effect.html#%3A%3E"><span class="hs-operator hs-type">:&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079373"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679079372"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079372"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079373"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-59"></span><span id="tell"><span class="annot"><span class="annottext">tell :: forall w (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]).
(Writer w :&gt; es, Monoid w) =&gt;
w -&gt; Eff es ()
</span><a href="Effectful.Writer.Static.Local.html#tell"><span class="hs-identifier hs-var hs-var">tell</span></a></span></span><span> </span><span id="local-6989586621679079461"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079461"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StaticRep (Writer w) -&gt; ((), StaticRep (Writer w))) -&gt; Eff es ()
forall (e :: (Type -&gt; Type) -&gt; Type -&gt; Type)
       (sideEffects :: SideEffects)
       (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(DispatchOf e ~ 'Static sideEffects, e :&gt; es) =&gt;
(StaticRep e -&gt; (a, StaticRep e)) -&gt; Eff es a
</span><a href="Effectful.Internal.Monad.html#stateStaticRep"><span class="hs-identifier hs-var">stateStaticRep</span></a></span><span> </span><span class="annot"><span class="annottext">((StaticRep (Writer w) -&gt; ((), StaticRep (Writer w))) -&gt; Eff es ())
-&gt; (StaticRep (Writer w) -&gt; ((), StaticRep (Writer w)))
-&gt; Eff es ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span id="local-6989586621679079463"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079463"><span class="hs-identifier hs-var">w0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">w -&gt; StaticRep (Writer w)
forall w. w -&gt; StaticRep (Writer w)
</span><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079463"><span class="hs-identifier hs-var">w0</span></a></span><span> </span><span class="annot"><span class="annottext">w -&gt; w -&gt; w
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079461"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | Execute an action and append its output to the overall output of the</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- 'Writer'.</span><span>
</span><span id="line-63"></span><span class="hs-comment">--</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- /Note:/ if an exception is received while the action is executed, the partial</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- output of the action will still be appended to the overall output of the</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- 'Writer':</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- &gt;&gt;&gt; :{</span><span>
</span><span id="line-69"></span><span class="hs-comment">--   runEff . execWriter @String $ do</span><span>
</span><span id="line-70"></span><span class="hs-comment">--     tell &quot;Hi&quot;</span><span>
</span><span id="line-71"></span><span class="hs-comment">--     handle (\(_::ErrorCall) -&gt; pure ((), &quot;&quot;)) $ do</span><span>
</span><span id="line-72"></span><span class="hs-comment">--       tell &quot; there&quot;</span><span>
</span><span id="line-73"></span><span class="hs-comment">--       listen $ do</span><span>
</span><span id="line-74"></span><span class="hs-comment">--         tell &quot;!&quot;</span><span>
</span><span id="line-75"></span><span class="hs-comment">--         error &quot;oops&quot;</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- :}</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- &quot;Hi there!&quot;</span><span>
</span><span id="line-78"></span><span id="local-6989586621679079385"><span id="local-6989586621679079386"><span id="local-6989586621679079387"><span class="annot"><a href="Effectful.Writer.Static.Local.html#listen"><span class="hs-identifier hs-type">listen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079385"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="Effectful.Internal.Effect.html#%3A%3E"><span class="hs-operator hs-type">:&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079386"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679079385"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079386"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079387"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079386"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679079387"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679079385"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-79"></span><span id="listen"><span class="annot"><span class="annottext">listen :: forall w (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(Writer w :&gt; es, Monoid w) =&gt;
Eff es a -&gt; Eff es (a, w)
</span><a href="Effectful.Writer.Static.Local.html#listen"><span class="hs-identifier hs-var hs-var">listen</span></a></span></span><span> </span><span id="local-6989586621679079480"><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621679079480"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env es -&gt; IO (a, w)) -&gt; Eff es (a, w)
forall (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(Env es -&gt; IO a) -&gt; Eff es a
</span><a href="Effectful.Internal.Monad.html#unsafeEff"><span class="hs-identifier hs-var">unsafeEff</span></a></span><span> </span><span class="annot"><span class="annottext">((Env es -&gt; IO (a, w)) -&gt; Eff es (a, w))
-&gt; (Env es -&gt; IO (a, w)) -&gt; Eff es (a, w)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679079482"><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079482"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((forall a. IO a -&gt; IO a) -&gt; IO (a, w)) -&gt; IO (a, w)
forall b. ((forall a. IO a -&gt; IO a) -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. IO a -&gt; IO a) -&gt; IO (a, w)) -&gt; IO (a, w))
-&gt; ((forall a. IO a -&gt; IO a) -&gt; IO (a, w)) -&gt; IO (a, w)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679079483"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679079483"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>  </span><span id="local-6989586621679079484"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079484"><span class="hs-identifier hs-var">w0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env es
-&gt; (EffectRep (DispatchOf (Writer w)) (Writer w)
    -&gt; IO (w, EffectRep (DispatchOf (Writer w)) (Writer w)))
-&gt; IO w
forall (e :: (Type -&gt; Type) -&gt; Type -&gt; Type)
       (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(e :&gt; es) =&gt;
Env es
-&gt; (EffectRep (DispatchOf e) e
    -&gt; IO (a, EffectRep (DispatchOf e) e))
-&gt; IO a
</span><a href="Effectful.Internal.Env.html#stateEnv"><span class="hs-identifier hs-var">stateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079482"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">((EffectRep (DispatchOf (Writer w)) (Writer w)
  -&gt; IO (w, EffectRep (DispatchOf (Writer w)) (Writer w)))
 -&gt; IO w)
-&gt; (EffectRep (DispatchOf (Writer w)) (Writer w)
    -&gt; IO (w, EffectRep (DispatchOf (Writer w)) (Writer w)))
-&gt; IO w
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span id="local-6989586621679079486"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079486"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(w, StaticRep (Writer w)) -&gt; IO (w, StaticRep (Writer w))
forall a. a -&gt; IO a
forall (f :: Type -&gt; Type) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079486"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">w -&gt; StaticRep (Writer w)
forall w. w -&gt; StaticRep (Writer w)
</span><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span><span> </span><span class="annot"><span class="annottext">w
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>  </span><span id="local-6989586621679079487"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079487"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679079483"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Eff es a -&gt; Env es -&gt; IO a
forall (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
Eff es a -&gt; Env es -&gt; IO a
</span><a href="Effectful.Internal.Monad.html#unEff"><span class="hs-identifier hs-var">unEff</span></a></span><span> </span><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621679079480"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079482"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO w -&gt; IO a
forall a b. IO a -&gt; IO b -&gt; IO a
</span><span class="hs-operator hs-var">`onException`</span></span><span> </span><span class="annot"><span class="annottext">Env es -&gt; w -&gt; IO w
forall {a} {es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]}.
(Writer a :&gt; es, Semigroup a) =&gt;
Env es -&gt; a -&gt; IO a
</span><a href="#local-6989586621679079489"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079482"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079484"><span class="hs-identifier hs-var">w0</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079487"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(w -&gt; (a, w)) -&gt; IO w -&gt; IO (a, w)
forall (f :: Type -&gt; Type) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env es -&gt; w -&gt; IO w
forall {a} {es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]}.
(Writer a :&gt; es, Semigroup a) =&gt;
Env es -&gt; a -&gt; IO a
</span><a href="#local-6989586621679079489"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079482"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079484"><span class="hs-identifier hs-var">w0</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621679079489"><span class="annot"><span class="annottext">merge :: Env es -&gt; a -&gt; IO a
</span><a href="#local-6989586621679079489"><span class="hs-identifier hs-var hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621679079496"><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079496"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679079497"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079497"><span class="hs-identifier hs-var">w0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-comment">-- If an exception is thrown, restore w0 and keep parts of w1.</span><span>
</span><span id="line-86"></span><span>      </span><span class="annot"><span class="annottext">Env es
-&gt; (EffectRep (DispatchOf (Writer a)) (Writer a)
    -&gt; IO (a, EffectRep (DispatchOf (Writer a)) (Writer a)))
-&gt; IO a
forall (e :: (Type -&gt; Type) -&gt; Type -&gt; Type)
       (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(e :&gt; es) =&gt;
Env es
-&gt; (EffectRep (DispatchOf e) e
    -&gt; IO (a, EffectRep (DispatchOf e) e))
-&gt; IO a
</span><a href="Effectful.Internal.Env.html#stateEnv"><span class="hs-identifier hs-var">stateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env es
</span><a href="#local-6989586621679079496"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">((EffectRep (DispatchOf (Writer a)) (Writer a)
  -&gt; IO (a, EffectRep (DispatchOf (Writer a)) (Writer a)))
 -&gt; IO a)
-&gt; (EffectRep (DispatchOf (Writer a)) (Writer a)
    -&gt; IO (a, EffectRep (DispatchOf (Writer a)) (Writer a)))
-&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span id="local-6989586621679079498"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079498"><span class="hs-identifier hs-var">w1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(a, StaticRep (Writer a)) -&gt; IO (a, StaticRep (Writer a))
forall a. a -&gt; IO a
forall (f :: Type -&gt; Type) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079498"><span class="hs-identifier hs-var">w1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; StaticRep (Writer a)
forall w. w -&gt; StaticRep (Writer w)
</span><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-var">Writer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079497"><span class="hs-identifier hs-var">w0</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079498"><span class="hs-identifier hs-var">w1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- | Execute an action and append its output to the overall output of the</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- 'Writer', then return the final value along with a function of the recorded</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- output.</span><span>
</span><span id="line-91"></span><span class="hs-comment">--</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- @'listens' f m &#8801; 'Data.Bifunctor.second' f '&lt;$&gt;' 'listen' m@</span><span>
</span><span id="line-93"></span><span id="local-6989586621679079409"><span id="local-6989586621679079410"><span id="local-6989586621679079411"><span id="local-6989586621679079412"><span class="annot"><a href="Effectful.Writer.Static.Local.html#listens"><span class="hs-identifier hs-type">listens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Effectful.Writer.Static.Local.html#Writer"><span class="hs-identifier hs-type">Writer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079409"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="Effectful.Internal.Effect.html#%3A%3E"><span class="hs-operator hs-type">:&gt;</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079410"><span class="hs-identifier hs-type">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621679079409"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679079409"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079411"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079410"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079412"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Effectful.Internal.Monad.html#Eff"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079410"><span class="hs-identifier hs-type">es</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679079412"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679079411"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-94"></span><span id="listens"><span class="annot"><span class="annottext">listens :: forall w (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) b a.
(Writer w :&gt; es, Monoid w) =&gt;
(w -&gt; b) -&gt; Eff es a -&gt; Eff es (a, b)
</span><a href="Effectful.Writer.Static.Local.html#listens"><span class="hs-identifier hs-var hs-var">listens</span></a></span></span><span> </span><span id="local-6989586621679079505"><span class="annot"><span class="annottext">w -&gt; b
</span><a href="#local-6989586621679079505"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679079506"><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621679079506"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679079507"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079507"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679079508"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079508"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff es a -&gt; Eff es (a, w)
forall w (es :: [(Type -&gt; Type) -&gt; Type -&gt; Type]) a.
(Writer w :&gt; es, Monoid w) =&gt;
Eff es a -&gt; Eff es (a, w)
</span><a href="Effectful.Writer.Static.Local.html#listen"><span class="hs-identifier hs-var">listen</span></a></span><span> </span><span class="annot"><span class="annottext">Eff es a
</span><a href="#local-6989586621679079506"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="annottext">(a, b) -&gt; Eff es (a, b)
forall a. a -&gt; Eff es a
forall (f :: Type -&gt; Type) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079507"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">w -&gt; b
</span><a href="#local-6989586621679079505"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621679079508"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">-- $setup</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- &gt;&gt;&gt; import Control.Exception (ErrorCall)</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- &gt;&gt;&gt; import Control.Monad.Catch</span><span>
</span><span id="line-101"></span></pre></body></html>