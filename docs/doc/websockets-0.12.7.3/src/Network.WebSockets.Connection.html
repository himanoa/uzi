<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- | This module exposes connection internals and should only be used if you</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- really know what you are doing.</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.WebSockets.Connection</span><span>
</span><span id="line-6"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier">PendingConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#acceptRequest"><span class="hs-identifier">acceptRequest</span></a></span><span>
</span><span id="line-8"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#AcceptRequest"><span class="hs-identifier">AcceptRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#defaultAcceptRequest"><span class="hs-identifier">defaultAcceptRequest</span></a></span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#acceptRequestWith"><span class="hs-identifier">acceptRequestWith</span></a></span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#rejectRequest"><span class="hs-identifier">rejectRequest</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#RejectRequest"><span class="hs-identifier">RejectRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#defaultRejectRequest"><span class="hs-identifier">defaultRejectRequest</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#rejectRequestWith"><span class="hs-identifier">rejectRequestWith</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier">Connection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#ConnectionOptions"><span class="hs-identifier">ConnectionOptions</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#defaultConnectionOptions"><span class="hs-identifier">defaultConnectionOptions</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#receive"><span class="hs-identifier">receive</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#receiveDataMessage"><span class="hs-identifier">receiveDataMessage</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#receiveData"><span class="hs-identifier">receiveData</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier">send</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendDataMessage"><span class="hs-identifier">sendDataMessage</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendDataMessages"><span class="hs-identifier">sendDataMessages</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendTextData"><span class="hs-identifier">sendTextData</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendTextDatas"><span class="hs-identifier">sendTextDatas</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendBinaryData"><span class="hs-identifier">sendBinaryData</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendBinaryDatas"><span class="hs-identifier">sendBinaryDatas</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendClose"><span class="hs-identifier">sendClose</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendCloseCode"><span class="hs-identifier">sendCloseCode</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#sendPing"><span class="hs-identifier">sendPing</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#withPingThread"><span class="hs-identifier">withPingThread</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#forkPingThread"><span class="hs-identifier">forkPingThread</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#pingThread"><span class="hs-identifier">pingThread</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#CompressionOptions"><span class="hs-identifier">CompressionOptions</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#PermessageDeflate"><span class="hs-identifier">PermessageDeflate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#defaultPermessageDeflate"><span class="hs-identifier">defaultPermessageDeflate</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#SizeLimit"><span class="hs-identifier">SizeLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;$&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forkIO</span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">threadDelay</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Async</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AsyncException</span></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">fromException</span></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">handle</span></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span>                                 </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder</span></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Builder</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span>                           </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B8</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>                                                                  </span><span class="annot"><span class="hs-identifier">writeIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span>                                       </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>                                       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word16</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html"><span class="hs-identifier">Network.WebSockets.Connection.Options</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Extensions.html"><span class="hs-identifier">Network.WebSockets.Extensions</span></a></span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Extensions</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Extensions.PermessageDeflate.html"><span class="hs-identifier">Network.WebSockets.Extensions.PermessageDeflate</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Extensions.StrictUnicode.html"><span class="hs-identifier">Network.WebSockets.Extensions.StrictUnicode</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Http.html"><span class="hs-identifier">Network.WebSockets.Http</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Protocol.html"><span class="hs-identifier">Network.WebSockets.Protocol</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Stream.html"><span class="hs-identifier">Network.WebSockets.Stream</span></a></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="Network.WebSockets.Stream.html#Stream"><span class="hs-identifier">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Network.WebSockets.Stream.html"><span class="hs-identifier">Network.WebSockets.Stream</span></a></span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Stream</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.WebSockets.Types.html"><span class="hs-identifier">Network.WebSockets.Types</span></a></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | A new client connected to the server. We haven't accepted the connection</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- yet, though.</span><span>
</span><span id="line-87"></span><span class="hs-keyword">data</span><span> </span><span id="PendingConnection"><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-var">PendingConnection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PendingConnection"><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-var">PendingConnection</span></a></span></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="pendingOptions"><span class="annot"><span class="annottext">PendingConnection -&gt; ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#pendingOptions"><span class="hs-identifier hs-var hs-var">pendingOptions</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#ConnectionOptions"><span class="hs-identifier hs-type">ConnectionOptions</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Options, passed as-is to the 'Connection'</span></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pendingRequest"><span class="annot"><span class="annottext">PendingConnection -&gt; RequestHead
</span><a href="Network.WebSockets.Connection.html#pendingRequest"><span class="hs-identifier hs-var hs-var">pendingRequest</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Http.html#RequestHead"><span class="hs-identifier hs-type">RequestHead</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Useful for e.g. inspecting the request path.</span></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pendingOnAccept"><span class="annot"><span class="annottext">PendingConnection -&gt; Connection -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#pendingOnAccept"><span class="hs-identifier hs-var hs-var">pendingOnAccept</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- ^ One-shot callback fired when a connection is accepted, i.e., *after*</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- the accepting response is sent to the client.</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pendingStream"><span class="annot"><span class="annottext">PendingConnection -&gt; Stream
</span><a href="Network.WebSockets.Connection.html#pendingStream"><span class="hs-identifier hs-var hs-var">pendingStream</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Input/output stream</span></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | This datatype allows you to set options for 'acceptRequestWith'.  It is</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- strongly recommended to use 'defaultAcceptRequest' and then modify the</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- various fields, that way new fields introduced in the library do not break</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- your code.</span><span>
</span><span id="line-105"></span><span class="hs-keyword">data</span><span> </span><span id="AcceptRequest"><span class="annot"><a href="Network.WebSockets.Connection.html#AcceptRequest"><span class="hs-identifier hs-var">AcceptRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AcceptRequest"><span class="annot"><a href="Network.WebSockets.Connection.html#AcceptRequest"><span class="hs-identifier hs-var">AcceptRequest</span></a></span></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="acceptSubprotocol"><span class="annot"><span class="annottext">AcceptRequest -&gt; Maybe ByteString
</span><a href="Network.WebSockets.Connection.html#acceptSubprotocol"><span class="hs-identifier hs-var hs-var">acceptSubprotocol</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">-- ^ The subprotocol to speak with the client.  If 'pendingSubprotcols' is</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-comment">-- non-empty, 'acceptSubprotocol' must be one of the subprotocols from the</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- list.</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="acceptHeaders"><span class="annot"><span class="annottext">AcceptRequest -&gt; Headers
</span><a href="Network.WebSockets.Connection.html#acceptHeaders"><span class="hs-identifier hs-var hs-var">acceptHeaders</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Http.html#Headers"><span class="hs-identifier hs-type">Headers</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Extra headers to send with the response.</span></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-116"></span><span class="annot"><a href="Network.WebSockets.Connection.html#defaultAcceptRequest"><span class="hs-identifier hs-type">defaultAcceptRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#AcceptRequest"><span class="hs-identifier hs-type">AcceptRequest</span></a></span><span>
</span><span id="line-117"></span><span id="defaultAcceptRequest"><span class="annot"><span class="annottext">defaultAcceptRequest :: AcceptRequest
</span><a href="Network.WebSockets.Connection.html#defaultAcceptRequest"><span class="hs-identifier hs-var hs-var">defaultAcceptRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Headers -&gt; AcceptRequest
</span><a href="Network.WebSockets.Connection.html#AcceptRequest"><span class="hs-identifier hs-var">AcceptRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-121"></span><span class="annot"><span class="hs-comment">-- | Utility</span></span><span>
</span><span id="line-122"></span><span class="annot"><a href="Network.WebSockets.Connection.html#sendResponse"><span class="hs-identifier hs-type">sendResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-type">PendingConnection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Http.html#Response"><span class="hs-identifier hs-type">Response</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span id="sendResponse"><span class="annot"><span class="annottext">sendResponse :: PendingConnection -&gt; Response -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendResponse"><span class="hs-identifier hs-var hs-var">sendResponse</span></a></span></span><span> </span><span id="local-6989586621679079216"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079216"><span class="hs-identifier hs-var">pc</span></a></span></span><span> </span><span id="local-6989586621679079217"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679079217"><span class="hs-identifier hs-var">rsp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream -&gt; ByteString -&gt; IO ()
</span><a href="Network.WebSockets.Stream.html#write"><span class="hs-identifier hs-var">Stream.write</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingConnection -&gt; Stream
</span><a href="Network.WebSockets.Connection.html#pendingStream"><span class="hs-identifier hs-var">pendingStream</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079216"><span class="hs-identifier hs-var">pc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; ByteString
</span><span class="hs-identifier hs-var">Builder.toLazyByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response -&gt; Builder
</span><a href="Network.WebSockets.Http.html#encodeResponse"><span class="hs-identifier hs-var">encodeResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679079217"><span class="hs-identifier hs-var">rsp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-128"></span><span class="annot"><span class="hs-comment">-- | Accept a pending connection, turning it into a 'Connection'.</span></span><span>
</span><span id="line-129"></span><span class="annot"><a href="Network.WebSockets.Connection.html#acceptRequest"><span class="hs-identifier hs-type">acceptRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-type">PendingConnection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span>
</span><span id="line-130"></span><span id="acceptRequest"><span class="annot"><span class="annottext">acceptRequest :: PendingConnection -&gt; IO Connection
</span><a href="Network.WebSockets.Connection.html#acceptRequest"><span class="hs-identifier hs-var hs-var">acceptRequest</span></a></span></span><span> </span><span id="local-6989586621679079221"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079221"><span class="hs-identifier hs-var">pc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; AcceptRequest -&gt; IO Connection
</span><a href="Network.WebSockets.Connection.html#acceptRequestWith"><span class="hs-identifier hs-var">acceptRequestWith</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079221"><span class="hs-identifier hs-var">pc</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptRequest
</span><a href="Network.WebSockets.Connection.html#defaultAcceptRequest"><span class="hs-identifier hs-var">defaultAcceptRequest</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | This function is like 'acceptRequest' but allows you to set custom options</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- using the 'AcceptRequest' datatype.</span><span>
</span><span id="line-136"></span><span class="annot"><a href="Network.WebSockets.Connection.html#acceptRequestWith"><span class="hs-identifier hs-type">acceptRequestWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-type">PendingConnection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#AcceptRequest"><span class="hs-identifier hs-type">AcceptRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span>
</span><span id="line-137"></span><span id="acceptRequestWith"><span class="annot"><span class="annottext">acceptRequestWith :: PendingConnection -&gt; AcceptRequest -&gt; IO Connection
</span><a href="Network.WebSockets.Connection.html#acceptRequestWith"><span class="hs-identifier hs-var hs-var">acceptRequestWith</span></a></span></span><span> </span><span id="local-6989586621679079222"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span></span><span> </span><span id="local-6989586621679079223"><span class="annot"><span class="annottext">AcceptRequest
</span><a href="#local-6989586621679079223"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Protocol -&gt; Bool) -&gt; [Protocol] -&gt; Maybe Protocol
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Protocol -&gt; RequestHead -&gt; Bool)
-&gt; RequestHead -&gt; Protocol -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Protocol -&gt; RequestHead -&gt; Bool
</span><a href="Network.WebSockets.Protocol.html#compatible"><span class="hs-identifier hs-var">compatible</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHead
</span><a href="#local-6989586621679079226"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Protocol]
</span><a href="Network.WebSockets.Protocol.html#protocols"><span class="hs-identifier hs-var">protocols</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">Maybe Protocol
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">PendingConnection -&gt; Response -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendResponse"><span class="hs-identifier hs-var">sendResponse</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span> </span><span class="annot"><span class="annottext">(Response -&gt; IO ()) -&gt; Response -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Headers -&gt; ByteString -&gt; Response
</span><a href="Network.WebSockets.Http.html#response400"><span class="hs-identifier hs-var">response400</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679079229"><span class="hs-identifier hs-var">versionHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">HandshakeException -&gt; IO Connection
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">HandshakeException
</span><a href="Network.WebSockets.Http.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679079231"><span class="annot"><span class="annottext">Protocol
</span><a href="#local-6989586621679079231"><span class="hs-identifier hs-var">protocol</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-comment">-- Get requested list of exceptions from client.</span><span>
</span><span id="line-144"></span><span>        </span><span id="local-6989586621679079232"><span class="annot"><span class="annottext">ExtensionDescriptions
</span><a href="#local-6989586621679079232"><span class="hs-identifier hs-var">rqExts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HandshakeException -&gt; IO ExtensionDescriptions)
-&gt; (ExtensionDescriptions -&gt; IO ExtensionDescriptions)
-&gt; Either HandshakeException ExtensionDescriptions
-&gt; IO ExtensionDescriptions
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">HandshakeException -&gt; IO ExtensionDescriptions
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">ExtensionDescriptions -&gt; IO ExtensionDescriptions
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either HandshakeException ExtensionDescriptions
 -&gt; IO ExtensionDescriptions)
-&gt; Either HandshakeException ExtensionDescriptions
-&gt; IO ExtensionDescriptions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-145"></span><span>            </span><span class="annot"><span class="annottext">RequestHead -&gt; Either HandshakeException ExtensionDescriptions
</span><a href="Network.WebSockets.Http.html#getRequestSecWebSocketExtensions"><span class="hs-identifier hs-var">getRequestSecWebSocketExtensions</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHead
</span><a href="#local-6989586621679079226"><span class="hs-identifier hs-var">request</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-comment">-- Set up permessage-deflate extension if configured.</span><span>
</span><span id="line-148"></span><span>        </span><span id="local-6989586621679079235"><span class="annot"><span class="annottext">Maybe Extension
</span><a href="#local-6989586621679079235"><span class="hs-identifier hs-var">pmdExt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConnectionOptions -&gt; CompressionOptions
</span><a href="Network.WebSockets.Connection.Options.html#connectionCompressionOptions"><span class="hs-identifier hs-var">connectionCompressionOptions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingConnection -&gt; ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#pendingOptions"><span class="hs-identifier hs-var">pendingOptions</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-149"></span><span>            </span><span class="annot"><span class="annottext">CompressionOptions
</span><a href="Network.WebSockets.Connection.Options.html#NoCompression"><span class="hs-identifier hs-var">NoCompression</span></a></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Extension -&gt; IO (Maybe Extension)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Extension
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-150"></span><span>            </span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#PermessageDeflateCompression"><span class="hs-identifier hs-type">PermessageDeflateCompression</span></a></span><span> </span><span id="local-6989586621679079239"><span class="annot"><span class="annottext">PermessageDeflate
</span><a href="#local-6989586621679079239"><span class="hs-identifier hs-var">pmd0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SizeLimit -&gt; Maybe PermessageDeflate -&gt; NegotiateExtension
</span><a href="Network.WebSockets.Extensions.PermessageDeflate.html#negotiateDeflate"><span class="hs-identifier hs-var">negotiateDeflate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionOptions -&gt; SizeLimit
</span><a href="Network.WebSockets.Connection.Options.html#connectionMessageDataSizeLimit"><span class="hs-identifier hs-var">connectionMessageDataSizeLimit</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="#local-6989586621679079242"><span class="hs-identifier hs-var">options</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PermessageDeflate -&gt; Maybe PermessageDeflate
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PermessageDeflate
</span><a href="#local-6989586621679079239"><span class="hs-identifier hs-var">pmd0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtensionDescriptions
</span><a href="#local-6989586621679079232"><span class="hs-identifier hs-var">rqExts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-152"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679079243"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679079243"><span class="hs-identifier hs-var">err</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>                        </span><span class="annot"><span class="annottext">PendingConnection -&gt; RejectRequest -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#rejectRequestWith"><span class="hs-identifier hs-var">rejectRequestWith</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span> </span><span class="annot"><span class="annottext">RejectRequest
</span><a href="Network.WebSockets.Connection.html#defaultRejectRequest"><span class="hs-identifier hs-var">defaultRejectRequest</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Network.WebSockets.Connection.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B8.pack</span></span><span> </span><span class="annot"><a href="#local-6989586621679079243"><span class="hs-identifier hs-type">err</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-154"></span><span>                        </span><span class="annot"><span class="annottext">HandshakeException -&gt; IO (Maybe Extension)
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">HandshakeException
</span><a href="Network.WebSockets.Http.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span>
</span><span id="line-155"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679079246"><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621679079246"><span class="hs-identifier hs-var">pmd1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Extension -&gt; IO (Maybe Extension)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; Maybe Extension
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621679079246"><span class="hs-identifier hs-var">pmd1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-comment">-- Set up strict utf8 extension if configured.</span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679079247"><span class="annot"><span class="annottext">unicodeExt :: Maybe Extension
</span><a href="#local-6989586621679079247"><span class="hs-identifier hs-var hs-var">unicodeExt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-159"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ConnectionOptions -&gt; Bool
</span><a href="Network.WebSockets.Connection.Options.html#connectionStrictUnicode"><span class="hs-identifier hs-var">connectionStrictUnicode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingConnection -&gt; ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#pendingOptions"><span class="hs-identifier hs-var">pendingOptions</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; Maybe Extension
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Extension
</span><a href="Network.WebSockets.Extensions.StrictUnicode.html#strictUnicode"><span class="hs-identifier hs-var">strictUnicode</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Extension
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-comment">-- Final extension list.</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679079250"><span class="annot"><span class="annottext">exts :: [Extension]
</span><a href="#local-6989586621679079250"><span class="hs-identifier hs-var hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe Extension] -&gt; [Extension]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe Extension
</span><a href="#local-6989586621679079235"><span class="hs-identifier hs-var">pmdExt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Extension
</span><a href="#local-6989586621679079247"><span class="hs-identifier hs-var">unicodeExt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679079255"><span class="annot"><span class="annottext">subproto :: Headers
</span><a href="#local-6989586621679079255"><span class="hs-identifier hs-var hs-var">subproto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Headers -&gt; (ByteString -&gt; Headers) -&gt; Maybe ByteString -&gt; Headers
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679079257"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079257"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CI ByteString
</span><span class="hs-string">&quot;Sec-WebSocket-Protocol&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079257"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; Headers) -&gt; Maybe ByteString -&gt; Headers
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AcceptRequest -&gt; Maybe ByteString
</span><a href="Network.WebSockets.Connection.html#acceptSubprotocol"><span class="hs-identifier hs-var">acceptSubprotocol</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptRequest
</span><a href="#local-6989586621679079223"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-166"></span><span>            </span><span id="local-6989586621679079259"><span class="annot"><span class="annottext">headers :: Headers
</span><a href="#local-6989586621679079259"><span class="hs-identifier hs-var hs-var">headers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679079255"><span class="hs-identifier hs-var">subproto</span></a></span><span> </span><span class="annot"><span class="annottext">Headers -&gt; Headers -&gt; Headers
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">AcceptRequest -&gt; Headers
</span><a href="Network.WebSockets.Connection.html#acceptHeaders"><span class="hs-identifier hs-var">acceptHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptRequest
</span><a href="#local-6989586621679079223"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Headers -&gt; Headers -&gt; Headers
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Extension -&gt; Headers) -&gt; [Extension] -&gt; Headers
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Extension -&gt; Headers
</span><a href="Network.WebSockets.Extensions.html#extHeaders"><span class="hs-identifier hs-var">extHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">[Extension]
</span><a href="#local-6989586621679079250"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-167"></span><span>            </span><span id="local-6989586621679079262"><span class="annot"><span class="annottext">response :: Either HandshakeException Response
</span><a href="#local-6989586621679079262"><span class="hs-identifier hs-var hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Protocol
-&gt; RequestHead -&gt; Headers -&gt; Either HandshakeException Response
</span><a href="Network.WebSockets.Protocol.html#finishRequest"><span class="hs-identifier hs-var">finishRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Protocol
</span><a href="#local-6989586621679079231"><span class="hs-identifier hs-var">protocol</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHead
</span><a href="#local-6989586621679079226"><span class="hs-identifier hs-var">request</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679079259"><span class="hs-identifier hs-var">headers</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>        </span><span class="annot"><span class="annottext">(HandshakeException -&gt; IO ())
-&gt; (Response -&gt; IO ())
-&gt; Either HandshakeException Response
-&gt; IO ()
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">HandshakeException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingConnection -&gt; Response -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendResponse"><span class="hs-identifier hs-var">sendResponse</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either HandshakeException Response
</span><a href="#local-6989586621679079262"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>        </span><span id="local-6989586621679079264"><span class="annot"><span class="annottext">IO (Maybe Message)
</span><a href="#local-6989586621679079264"><span class="hs-identifier hs-var">parseRaw</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Protocol
-&gt; SizeLimit -&gt; SizeLimit -&gt; Stream -&gt; IO (IO (Maybe Message))
</span><a href="Network.WebSockets.Protocol.html#decodeMessages"><span class="hs-identifier hs-var">decodeMessages</span></a></span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><span class="annottext">Protocol
</span><a href="#local-6989586621679079231"><span class="hs-identifier hs-var">protocol</span></a></span><span>
</span><span id="line-173"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionOptions -&gt; SizeLimit
</span><a href="Network.WebSockets.Connection.Options.html#connectionFramePayloadSizeLimit"><span class="hs-identifier hs-var">connectionFramePayloadSizeLimit</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="#local-6989586621679079242"><span class="hs-identifier hs-var">options</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionOptions -&gt; SizeLimit
</span><a href="Network.WebSockets.Connection.Options.html#connectionMessageDataSizeLimit"><span class="hs-identifier hs-var">connectionMessageDataSizeLimit</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="#local-6989586621679079242"><span class="hs-identifier hs-var">options</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingConnection -&gt; Stream
</span><a href="Network.WebSockets.Connection.html#pendingStream"><span class="hs-identifier hs-var">pendingStream</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>        </span><span id="local-6989586621679079267"><span class="annot"><span class="annottext">[Message] -&gt; IO ()
</span><a href="#local-6989586621679079267"><span class="hs-identifier hs-var">writeRaw</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Protocol -&gt; ConnectionType -&gt; Stream -&gt; IO ([Message] -&gt; IO ())
</span><a href="Network.WebSockets.Protocol.html#encodeMessages"><span class="hs-identifier hs-var">encodeMessages</span></a></span><span> </span><span class="annot"><span class="annottext">Protocol
</span><a href="#local-6989586621679079231"><span class="hs-identifier hs-var">protocol</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionType
</span><a href="Network.WebSockets.Types.html#ServerConnection"><span class="hs-identifier hs-var">ServerConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingConnection -&gt; Stream
</span><a href="Network.WebSockets.Connection.html#pendingStream"><span class="hs-identifier hs-var">pendingStream</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>        </span><span id="local-6989586621679079270"><span class="annot"><span class="annottext">[Message] -&gt; IO ()
</span><a href="#local-6989586621679079270"><span class="hs-identifier hs-var">write</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(([Message] -&gt; IO ()) -&gt; Extension -&gt; IO ([Message] -&gt; IO ()))
-&gt; ([Message] -&gt; IO ()) -&gt; [Extension] -&gt; IO ([Message] -&gt; IO ())
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679079271"><span class="annot"><span class="annottext">[Message] -&gt; IO ()
</span><a href="#local-6989586621679079271"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679079272"><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621679079272"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; ([Message] -&gt; IO ()) -&gt; IO ([Message] -&gt; IO ())
</span><a href="Network.WebSockets.Extensions.html#extWrite"><span class="hs-identifier hs-var">extWrite</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621679079272"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">[Message] -&gt; IO ()
</span><a href="#local-6989586621679079271"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Message] -&gt; IO ()
</span><a href="#local-6989586621679079267"><span class="hs-identifier hs-var">writeRaw</span></a></span><span> </span><span class="annot"><span class="annottext">[Extension]
</span><a href="#local-6989586621679079250"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-179"></span><span>        </span><span id="local-6989586621679079274"><span class="annot"><span class="annottext">IO (Maybe Message)
</span><a href="#local-6989586621679079274"><span class="hs-identifier hs-var">parse</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IO (Maybe Message) -&gt; Extension -&gt; IO (IO (Maybe Message)))
-&gt; IO (Maybe Message) -&gt; [Extension] -&gt; IO (IO (Maybe Message))
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679079275"><span class="annot"><span class="annottext">IO (Maybe Message)
</span><a href="#local-6989586621679079275"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679079276"><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621679079276"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; IO (Maybe Message) -&gt; IO (IO (Maybe Message))
</span><a href="Network.WebSockets.Extensions.html#extParse"><span class="hs-identifier hs-var">extParse</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><a href="#local-6989586621679079276"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe Message)
</span><a href="#local-6989586621679079275"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Maybe Message)
</span><a href="#local-6989586621679079264"><span class="hs-identifier hs-var">parseRaw</span></a></span><span> </span><span class="annot"><span class="annottext">[Extension]
</span><a href="#local-6989586621679079250"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>        </span><span id="local-6989586621679079278"><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679079278"><span class="hs-identifier hs-var">sentRef</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (IORef Bool)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679079279"><span class="annot"><span class="annottext">connection :: Connection
</span><a href="#local-6989586621679079279"><span class="hs-identifier hs-var hs-var">connection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span>
</span><span id="line-183"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">connectionOptions :: ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#connectionOptions"><span class="hs-identifier hs-var">connectionOptions</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="#local-6989586621679079242"><span class="hs-identifier hs-var">options</span></a></span><span>
</span><span id="line-184"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">connectionType :: ConnectionType
</span><a href="Network.WebSockets.Connection.html#connectionType"><span class="hs-identifier hs-var">connectionType</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionType
</span><a href="Network.WebSockets.Types.html#ServerConnection"><span class="hs-identifier hs-var">ServerConnection</span></a></span><span>
</span><span id="line-185"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">connectionProtocol :: Protocol
</span><a href="Network.WebSockets.Connection.html#connectionProtocol"><span class="hs-identifier hs-var">connectionProtocol</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Protocol
</span><a href="#local-6989586621679079231"><span class="hs-identifier hs-var">protocol</span></a></span><span>
</span><span id="line-186"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">connectionParse :: IO (Maybe Message)
</span><a href="Network.WebSockets.Connection.html#connectionParse"><span class="hs-identifier hs-var">connectionParse</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe Message)
</span><a href="#local-6989586621679079274"><span class="hs-identifier hs-var">parse</span></a></span><span>
</span><span id="line-187"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">connectionWrite :: [Message] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#connectionWrite"><span class="hs-identifier hs-var">connectionWrite</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Message] -&gt; IO ()
</span><a href="#local-6989586621679079270"><span class="hs-identifier hs-var">write</span></a></span><span>
</span><span id="line-188"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">connectionSentClose :: IORef Bool
</span><a href="Network.WebSockets.Connection.html#connectionSentClose"><span class="hs-identifier hs-var">connectionSentClose</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679079278"><span class="hs-identifier hs-var">sentRef</span></a></span><span>
</span><span id="line-189"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><span class="annottext">PendingConnection -&gt; Connection -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#pendingOnAccept"><span class="hs-identifier hs-var">pendingOnAccept</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079279"><span class="hs-identifier hs-var">connection</span></a></span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; IO Connection
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079279"><span class="hs-identifier hs-var">connection</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621679079242"><span class="annot"><span class="annottext">options :: ConnectionOptions
</span><a href="#local-6989586621679079242"><span class="hs-identifier hs-var hs-var">options</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#pendingOptions"><span class="hs-identifier hs-var">pendingOptions</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621679079226"><span class="annot"><span class="annottext">request :: RequestHead
</span><a href="#local-6989586621679079226"><span class="hs-identifier hs-var hs-var">request</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; RequestHead
</span><a href="Network.WebSockets.Connection.html#pendingRequest"><span class="hs-identifier hs-var">pendingRequest</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079222"><span class="hs-identifier hs-var">pc</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621679079229"><span class="annot"><span class="annottext">versionHeader :: Headers
</span><a href="#local-6989586621679079229"><span class="hs-identifier hs-var hs-var">versionHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CI ByteString
</span><span class="hs-string">&quot;Sec-WebSocket-Version&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-197"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">B.intercalate</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;, &quot;</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Protocol -&gt; [ByteString]) -&gt; [Protocol] -&gt; [ByteString]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Protocol -&gt; [ByteString]
</span><a href="Network.WebSockets.Protocol.html#headerVersions"><span class="hs-identifier hs-var">headerVersions</span></a></span><span> </span><span class="annot"><span class="annottext">[Protocol]
</span><a href="Network.WebSockets.Protocol.html#protocols"><span class="hs-identifier hs-var">protocols</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- | Parameters that allow you to tweak how a request is rejected.  Please use</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- 'defaultRejectRequest' and modify fields using record syntax so your code</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- will not break when new fields are added.</span><span>
</span><span id="line-204"></span><span class="hs-keyword">data</span><span> </span><span id="RejectRequest"><span class="annot"><a href="Network.WebSockets.Connection.html#RejectRequest"><span class="hs-identifier hs-var">RejectRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RejectRequest"><span class="annot"><a href="Network.WebSockets.Connection.html#RejectRequest"><span class="hs-identifier hs-var">RejectRequest</span></a></span></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-comment">-- | The status code, 400 by default.</span></span><span>
</span><span id="line-206"></span><span>      </span><span id="rejectCode"><span class="annot"><span class="annottext">RejectRequest -&gt; Int
</span><a href="Network.WebSockets.Connection.html#rejectCode"><span class="hs-identifier hs-var hs-var">rejectCode</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-comment">-- | The message, &quot;Bad Request&quot; by default</span></span><span>
</span><span id="line-208"></span><span>      </span><span id="rejectMessage"><span class="annot"><span class="annottext">RejectRequest -&gt; ByteString
</span><a href="Network.WebSockets.Connection.html#rejectMessage"><span class="hs-identifier hs-var hs-var">rejectMessage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-comment">-- | Extra headers to be sent with the response.</span></span><span>
</span><span id="line-210"></span><span>      </span><span id="rejectHeaders"><span class="annot"><span class="annottext">RejectRequest -&gt; Headers
</span><a href="Network.WebSockets.Connection.html#rejectHeaders"><span class="hs-identifier hs-var hs-var">rejectHeaders</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Http.html#Headers"><span class="hs-identifier hs-type">Headers</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-comment">-- | Reponse body of the rejection.</span></span><span>
</span><span id="line-212"></span><span>      </span><span id="rejectBody"><span class="annot"><span class="annottext">RejectRequest -&gt; ByteString
</span><a href="Network.WebSockets.Connection.html#rejectBody"><span class="hs-identifier hs-var hs-var">rejectBody</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-217"></span><span class="annot"><a href="Network.WebSockets.Connection.html#defaultRejectRequest"><span class="hs-identifier hs-type">defaultRejectRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#RejectRequest"><span class="hs-identifier hs-type">RejectRequest</span></a></span><span>
</span><span id="line-218"></span><span id="defaultRejectRequest"><span class="annot"><span class="annottext">defaultRejectRequest :: RejectRequest
</span><a href="Network.WebSockets.Connection.html#defaultRejectRequest"><span class="hs-identifier hs-var hs-var">defaultRejectRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#RejectRequest"><span class="hs-identifier hs-type">RejectRequest</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rejectCode :: Int
</span><a href="Network.WebSockets.Connection.html#rejectCode"><span class="hs-identifier hs-var">rejectCode</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">400</span></span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rejectMessage :: ByteString
</span><a href="Network.WebSockets.Connection.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Bad Request&quot;</span></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rejectHeaders :: Headers
</span><a href="Network.WebSockets.Connection.html#rejectHeaders"><span class="hs-identifier hs-var">rejectHeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rejectBody :: ByteString
</span><a href="Network.WebSockets.Connection.html#rejectBody"><span class="hs-identifier hs-var">rejectBody</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-227"></span><span class="annot"><a href="Network.WebSockets.Connection.html#rejectRequestWith"><span class="hs-identifier hs-type">rejectRequestWith</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-type">PendingConnection</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Connection to reject</span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#RejectRequest"><span class="hs-identifier hs-type">RejectRequest</span></a></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Params on how to reject the request</span></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span id="rejectRequestWith"><span class="annot"><span class="annottext">rejectRequestWith :: PendingConnection -&gt; RejectRequest -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#rejectRequestWith"><span class="hs-identifier hs-var hs-var">rejectRequestWith</span></a></span></span><span> </span><span id="local-6989586621679079296"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079296"><span class="hs-identifier hs-var">pc</span></a></span></span><span> </span><span id="local-6989586621679079297"><span class="annot"><span class="annottext">RejectRequest
</span><a href="#local-6989586621679079297"><span class="hs-identifier hs-var">reject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; Response -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendResponse"><span class="hs-identifier hs-var">sendResponse</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079296"><span class="hs-identifier hs-var">pc</span></a></span><span> </span><span class="annot"><span class="annottext">(Response -&gt; IO ()) -&gt; Response -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResponseHead -&gt; ByteString -&gt; Response
</span><a href="Network.WebSockets.Http.html#Response"><span class="hs-identifier hs-var">Response</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="Network.WebSockets.Http.html#ResponseHead"><span class="hs-identifier hs-type">ResponseHead</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">responseCode :: Int
</span><a href="Network.WebSockets.Http.html#responseCode"><span class="hs-identifier hs-var">responseCode</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RejectRequest -&gt; Int
</span><a href="Network.WebSockets.Connection.html#rejectCode"><span class="hs-identifier hs-var">rejectCode</span></a></span><span> </span><span class="annot"><span class="annottext">RejectRequest
</span><a href="#local-6989586621679079297"><span class="hs-identifier hs-var">reject</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">responseMessage :: ByteString
</span><a href="Network.WebSockets.Http.html#responseMessage"><span class="hs-identifier hs-var">responseMessage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RejectRequest -&gt; ByteString
</span><a href="Network.WebSockets.Connection.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span> </span><span class="annot"><span class="annottext">RejectRequest
</span><a href="#local-6989586621679079297"><span class="hs-identifier hs-var">reject</span></a></span><span>
</span><span id="line-235"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">responseHeaders :: Headers
</span><a href="Network.WebSockets.Http.html#responseHeaders"><span class="hs-identifier hs-var">responseHeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RejectRequest -&gt; Headers
</span><a href="Network.WebSockets.Connection.html#rejectHeaders"><span class="hs-identifier hs-var">rejectHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">RejectRequest
</span><a href="#local-6989586621679079297"><span class="hs-identifier hs-var">reject</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectRequest -&gt; ByteString
</span><a href="Network.WebSockets.Connection.html#rejectBody"><span class="hs-identifier hs-var">rejectBody</span></a></span><span> </span><span class="annot"><span class="annottext">RejectRequest
</span><a href="#local-6989586621679079297"><span class="hs-identifier hs-var">reject</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-241"></span><span class="annot"><a href="Network.WebSockets.Connection.html#rejectRequest"><span class="hs-identifier hs-type">rejectRequest</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#PendingConnection"><span class="hs-identifier hs-type">PendingConnection</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Connection to reject</span></span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span>       </span><span class="annot"><span class="hs-comment">-- ^ Rejection response body</span></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span id="rejectRequest"><span class="annot"><span class="annottext">rejectRequest :: PendingConnection -&gt; ByteString -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#rejectRequest"><span class="hs-identifier hs-var hs-var">rejectRequest</span></a></span></span><span> </span><span id="local-6989586621679079303"><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079303"><span class="hs-identifier hs-var">pc</span></a></span></span><span> </span><span id="local-6989586621679079304"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079304"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PendingConnection -&gt; RejectRequest -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#rejectRequestWith"><span class="hs-identifier hs-var">rejectRequestWith</span></a></span><span> </span><span class="annot"><span class="annottext">PendingConnection
</span><a href="#local-6989586621679079303"><span class="hs-identifier hs-var">pc</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="annottext">RejectRequest
</span><a href="Network.WebSockets.Connection.html#defaultRejectRequest"><span class="hs-identifier hs-var">defaultRejectRequest</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Network.WebSockets.Connection.html#rejectBody"><span class="hs-identifier hs-var">rejectBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679079304"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-250"></span><span class="hs-keyword">data</span><span> </span><span id="Connection"><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-var">Connection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Connection"><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-var">Connection</span></a></span></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="connectionOptions"><span class="annot"><span class="annottext">Connection -&gt; ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#connectionOptions"><span class="hs-identifier hs-var hs-var">connectionOptions</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Connection.Options.html#ConnectionOptions"><span class="hs-identifier hs-type">ConnectionOptions</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="connectionType"><span class="annot"><span class="annottext">Connection -&gt; ConnectionType
</span><a href="Network.WebSockets.Connection.html#connectionType"><span class="hs-identifier hs-var hs-var">connectionType</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Types.html#ConnectionType"><span class="hs-identifier hs-type">ConnectionType</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="connectionProtocol"><span class="annot"><span class="annottext">Connection -&gt; Protocol
</span><a href="Network.WebSockets.Connection.html#connectionProtocol"><span class="hs-identifier hs-var hs-var">connectionProtocol</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Network.WebSockets.Protocol.html#Protocol"><span class="hs-identifier hs-type">Protocol</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="connectionParse"><span class="annot"><span class="annottext">Connection -&gt; IO (Maybe Message)
</span><a href="Network.WebSockets.Connection.html#connectionParse"><span class="hs-identifier hs-var hs-var">connectionParse</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="connectionWrite"><span class="annot"><span class="annottext">Connection -&gt; [Message] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#connectionWrite"><span class="hs-identifier hs-var hs-var">connectionWrite</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Network.WebSockets.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="connectionSentClose"><span class="annot"><span class="annottext">Connection -&gt; IORef Bool
</span><a href="Network.WebSockets.Connection.html#connectionSentClose"><span class="hs-identifier hs-var hs-var">connectionSentClose</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">-- ^ According to the RFC, both the client and the server MUST send</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- a close control message to each other.  Either party can initiate</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- the first close message but then the other party must respond.  Finally,</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- the server is in charge of closing the TCP connection.  This IORef tracks</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-comment">-- if we have sent a close message and are waiting for the peer to respond.</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-266"></span><span class="annot"><a href="Network.WebSockets.Connection.html#receive"><span class="hs-identifier hs-type">receive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span>
</span><span id="line-267"></span><span id="receive"><span class="annot"><span class="annottext">receive :: Connection -&gt; IO Message
</span><a href="Network.WebSockets.Connection.html#receive"><span class="hs-identifier hs-var hs-var">receive</span></a></span></span><span> </span><span id="local-6989586621679079305"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079305"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621679079306"><span class="annot"><span class="annottext">Maybe Message
</span><a href="#local-6989586621679079306"><span class="hs-identifier hs-var">mbMsg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO (Maybe Message)
</span><a href="Network.WebSockets.Connection.html#connectionParse"><span class="hs-identifier hs-var">connectionParse</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079305"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Message
</span><a href="#local-6989586621679079306"><span class="hs-identifier hs-var">mbMsg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="annottext">Maybe Message
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConnectionException -&gt; IO Message
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">ConnectionException
</span><a href="Network.WebSockets.Types.html#ConnectionClosed"><span class="hs-identifier hs-var">ConnectionClosed</span></a></span><span>
</span><span id="line-271"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679079308"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679079308"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Message -&gt; IO Message
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679079308"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- | Receive an application message. Automatically respond to control messages.</span><span>
</span><span id="line-276"></span><span class="hs-comment">--</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- When the peer sends a close control message, an exception of type 'CloseRequest'</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- is thrown.  The peer can send a close control message either to initiate a</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- close or in response to a close message we have sent to the peer.  In either</span><span>
</span><span id="line-280"></span><span class="hs-comment">-- case the 'CloseRequest' exception will be thrown.  The RFC specifies that</span><span>
</span><span id="line-281"></span><span class="hs-comment">-- the server is responsible for closing the TCP connection, which should happen</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- after receiving the 'CloseRequest' exception from this function.</span><span>
</span><span id="line-283"></span><span class="hs-comment">--</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- This will throw 'ConnectionClosed' if the TCP connection dies unexpectedly.</span><span>
</span><span id="line-285"></span><span class="annot"><a href="Network.WebSockets.Connection.html#receiveDataMessage"><span class="hs-identifier hs-type">receiveDataMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#DataMessage"><span class="hs-identifier hs-type">DataMessage</span></a></span><span>
</span><span id="line-286"></span><span id="receiveDataMessage"><span class="annot"><span class="annottext">receiveDataMessage :: Connection -&gt; IO DataMessage
</span><a href="Network.WebSockets.Connection.html#receiveDataMessage"><span class="hs-identifier hs-var hs-var">receiveDataMessage</span></a></span></span><span> </span><span id="local-6989586621679079310"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621679079311"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679079311"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO Message
</span><a href="Network.WebSockets.Connection.html#receive"><span class="hs-identifier hs-var">receive</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679079311"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><a href="Network.WebSockets.Types.html#DataMessage"><span class="hs-identifier hs-type">DataMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679079313"><span class="annot"><span class="annottext">DataMessage
</span><a href="#local-6989586621679079313"><span class="hs-identifier hs-var">am</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DataMessage -&gt; IO DataMessage
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">DataMessage
</span><a href="#local-6989586621679079313"><span class="hs-identifier hs-var">am</span></a></span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><a href="Network.WebSockets.Types.html#ControlMessage"><span class="hs-identifier hs-type">ControlMessage</span></a></span><span> </span><span id="local-6989586621679079315"><span class="annot"><span class="annottext">ControlMessage
</span><a href="#local-6989586621679079315"><span class="hs-identifier hs-var">cm</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="#local-6989586621679079315"><span class="hs-identifier hs-var">cm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><a href="Network.WebSockets.Types.html#Close"><span class="hs-identifier hs-type">Close</span></a></span><span> </span><span id="local-6989586621679079317"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679079317"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679079318"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079318"><span class="hs-identifier hs-var">closeMsg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>                </span><span id="local-6989586621679079319"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679079319"><span class="hs-identifier hs-var">hasSentClose</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; IO Bool
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Bool -&gt; IO Bool) -&gt; IORef Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IORef Bool
</span><a href="Network.WebSockets.Connection.html#connectionSentClose"><span class="hs-identifier hs-var">connectionSentClose</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-293"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679079319"><span class="hs-identifier hs-var">hasSentClose</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Message -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679079311"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-294"></span><span>                </span><span class="annot"><span class="annottext">ConnectionException -&gt; IO DataMessage
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ConnectionException -&gt; IO DataMessage)
-&gt; ConnectionException -&gt; IO DataMessage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; ByteString -&gt; ConnectionException
</span><a href="Network.WebSockets.Types.html#CloseRequest"><span class="hs-identifier hs-var">CloseRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679079317"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079318"><span class="hs-identifier hs-var">closeMsg</span></a></span><span>
</span><span id="line-295"></span><span>            </span><span class="annot"><a href="Network.WebSockets.Types.html#Pong"><span class="hs-identifier hs-type">Pong</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>                </span><span class="annot"><span class="annottext">ConnectionOptions -&gt; IO ()
</span><a href="Network.WebSockets.Connection.Options.html#connectionOnPong"><span class="hs-identifier hs-var">connectionOnPong</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; ConnectionOptions
</span><a href="Network.WebSockets.Connection.html#connectionOptions"><span class="hs-identifier hs-var">connectionOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>                </span><span class="annot"><span class="annottext">Connection -&gt; IO DataMessage
</span><a href="Network.WebSockets.Connection.html#receiveDataMessage"><span class="hs-identifier hs-var">receiveDataMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-298"></span><span>            </span><span class="annot"><a href="Network.WebSockets.Types.html#Ping"><span class="hs-identifier hs-type">Ping</span></a></span><span> </span><span id="local-6989586621679079323"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079323"><span class="hs-identifier hs-var">pl</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>                </span><span class="annot"><span class="annottext">Connection -&gt; Message -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ControlMessage -&gt; Message
</span><a href="Network.WebSockets.Types.html#ControlMessage"><span class="hs-identifier hs-var">ControlMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ControlMessage
</span><a href="Network.WebSockets.Types.html#Pong"><span class="hs-identifier hs-var">Pong</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679079323"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>                </span><span class="annot"><span class="annottext">Connection -&gt; IO DataMessage
</span><a href="Network.WebSockets.Connection.html#receiveDataMessage"><span class="hs-identifier hs-var">receiveDataMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079310"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-304"></span><span class="annot"><span class="hs-comment">-- | Receive a message, converting it to whatever format is needed.</span></span><span>
</span><span id="line-305"></span><span id="local-6989586621679079056"><span class="annot"><a href="Network.WebSockets.Connection.html#receiveData"><span class="hs-identifier hs-type">receiveData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079056"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679079056"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-306"></span><span id="receiveData"><span class="annot"><span class="annottext">receiveData :: forall a. WebSocketsData a =&gt; Connection -&gt; IO a
</span><a href="Network.WebSockets.Connection.html#receiveData"><span class="hs-identifier hs-var hs-var">receiveData</span></a></span></span><span> </span><span id="local-6989586621679079328"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079328"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataMessage -&gt; a
forall a. WebSocketsData a =&gt; DataMessage -&gt; a
</span><a href="Network.WebSockets.Types.html#fromDataMessage"><span class="hs-identifier hs-var">fromDataMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(DataMessage -&gt; a) -&gt; IO DataMessage -&gt; IO a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO DataMessage
</span><a href="Network.WebSockets.Connection.html#receiveDataMessage"><span class="hs-identifier hs-var">receiveDataMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079328"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-310"></span><span class="annot"><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier hs-type">send</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span id="send"><span class="annot"><span class="annottext">send :: Connection -&gt; Message -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier hs-var hs-var">send</span></a></span></span><span> </span><span id="local-6989586621679079330"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079330"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; [Message] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendAll"><span class="hs-identifier hs-var">sendAll</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079330"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([Message] -&gt; IO ()) -&gt; (Message -&gt; [Message]) -&gt; Message -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Message -&gt; [Message]
forall a. a -&gt; [a]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-314"></span><span class="annot"><a href="Network.WebSockets.Connection.html#sendAll"><span class="hs-identifier hs-type">sendAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.WebSockets.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span id="sendAll"><span class="annot"><span class="annottext">sendAll :: Connection -&gt; [Message] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendAll"><span class="hs-identifier hs-var hs-var">sendAll</span></a></span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span class="annot"><a href="Network.WebSockets.Connection.html#sendAll"><span class="hs-identifier hs-var">sendAll</span></a></span><span> </span><span id="local-6989586621679079333"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079333"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621679079334"><span class="annot"><span class="annottext">[Message]
</span><a href="#local-6989586621679079334"><span class="hs-identifier hs-var">msgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Message -&gt; Bool) -&gt; [Message] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Message -&gt; Bool
</span><a href="#local-6989586621679079336"><span class="hs-identifier hs-var">isCloseMessage</span></a></span><span> </span><span class="annot"><span class="annottext">[Message]
</span><a href="#local-6989586621679079334"><span class="hs-identifier hs-var">msgs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; IORef Bool
</span><a href="Network.WebSockets.Connection.html#connectionSentClose"><span class="hs-identifier hs-var">connectionSentClose</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079333"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; [Message] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#connectionWrite"><span class="hs-identifier hs-var">connectionWrite</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079333"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">[Message]
</span><a href="#local-6989586621679079334"><span class="hs-identifier hs-var">msgs</span></a></span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-321"></span><span>    </span><span id="local-6989586621679079336"><span class="annot"><span class="annottext">isCloseMessage :: Message -&gt; Bool
</span><a href="#local-6989586621679079336"><span class="hs-identifier hs-var hs-var">isCloseMessage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.WebSockets.Types.html#ControlMessage"><span class="hs-identifier hs-type">ControlMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.WebSockets.Types.html#Close"><span class="hs-identifier hs-type">Close</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="#local-6989586621679079336"><span class="hs-identifier hs-var">isCloseMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><span class="hs-identifier">_</span></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- | Send a 'DataMessage'.  This allows you send both human-readable text and</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- binary data.  This is a slightly more low-level interface than 'sendTextData'</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- or 'sendBinaryData'.</span><span>
</span><span id="line-328"></span><span class="annot"><a href="Network.WebSockets.Connection.html#sendDataMessage"><span class="hs-identifier hs-type">sendDataMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#DataMessage"><span class="hs-identifier hs-type">DataMessage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span id="sendDataMessage"><span class="annot"><span class="annottext">sendDataMessage :: Connection -&gt; DataMessage -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendDataMessage"><span class="hs-identifier hs-var hs-var">sendDataMessage</span></a></span></span><span> </span><span id="local-6989586621679079337"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079337"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; [DataMessage] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendDataMessages"><span class="hs-identifier hs-var">sendDataMessages</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079337"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([DataMessage] -&gt; IO ())
-&gt; (DataMessage -&gt; [DataMessage]) -&gt; DataMessage -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DataMessage -&gt; [DataMessage]
forall a. a -&gt; [a]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- | Send a collection of 'DataMessage's.  This is more efficient than calling</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- 'sendDataMessage' many times.</span><span>
</span><span id="line-334"></span><span class="annot"><a href="Network.WebSockets.Connection.html#sendDataMessages"><span class="hs-identifier hs-type">sendDataMessages</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.WebSockets.Types.html#DataMessage"><span class="hs-identifier hs-type">DataMessage</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span id="sendDataMessages"><span class="annot"><span class="annottext">sendDataMessages :: Connection -&gt; [DataMessage] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendDataMessages"><span class="hs-identifier hs-var hs-var">sendDataMessages</span></a></span></span><span> </span><span id="local-6989586621679079338"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079338"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; [Message] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendAll"><span class="hs-identifier hs-var">sendAll</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079338"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([Message] -&gt; IO ())
-&gt; ([DataMessage] -&gt; [Message]) -&gt; [DataMessage] -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(DataMessage -&gt; Message) -&gt; [DataMessage] -&gt; [Message]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool -&gt; DataMessage -&gt; Message
</span><a href="Network.WebSockets.Types.html#DataMessage"><span class="hs-identifier hs-var">DataMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Send a textual message.  The message will be encoded as UTF-8.  This should</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- be the default choice for human-readable text-based protocols such as JSON.</span><span>
</span><span id="line-340"></span><span id="local-6989586621679079070"><span class="annot"><a href="Network.WebSockets.Connection.html#sendTextData"><span class="hs-identifier hs-type">sendTextData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079070"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079070"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-341"></span><span id="sendTextData"><span class="annot"><span class="annottext">sendTextData :: forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendTextData"><span class="hs-identifier hs-var hs-var">sendTextData</span></a></span></span><span> </span><span id="local-6989586621679079342"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079342"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; [a] -&gt; IO ()
forall a. WebSocketsData a =&gt; Connection -&gt; [a] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendTextDatas"><span class="hs-identifier hs-var">sendTextDatas</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079342"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([a] -&gt; IO ()) -&gt; (a -&gt; [a]) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a]
forall a. a -&gt; [a]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-344"></span><span class="hs-comment">-- | Send a number of textual messages.  This is more efficient than calling</span><span>
</span><span id="line-345"></span><span class="hs-comment">-- 'sendTextData' many times.</span><span>
</span><span id="line-346"></span><span id="local-6989586621679079072"><span class="annot"><a href="Network.WebSockets.Connection.html#sendTextDatas"><span class="hs-identifier hs-type">sendTextDatas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079072"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679079072"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-347"></span><span id="sendTextDatas"><span class="annot"><span class="annottext">sendTextDatas :: forall a. WebSocketsData a =&gt; Connection -&gt; [a] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendTextDatas"><span class="hs-identifier hs-var hs-var">sendTextDatas</span></a></span></span><span> </span><span id="local-6989586621679079345"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079345"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; [DataMessage] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendDataMessages"><span class="hs-identifier hs-var">sendDataMessages</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079345"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([DataMessage] -&gt; IO ()) -&gt; ([a] -&gt; [DataMessage]) -&gt; [a] -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="annottext">(a -&gt; DataMessage) -&gt; [a] -&gt; [DataMessage]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679079346"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079346"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe Text -&gt; DataMessage
</span><a href="Network.WebSockets.Types.html#Text"><span class="hs-identifier hs-var">Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. WebSocketsData a =&gt; a -&gt; ByteString
</span><a href="Network.WebSockets.Types.html#toLazyByteString"><span class="hs-identifier hs-var">toLazyByteString</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679079346"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-352"></span><span class="hs-comment">-- | Send a binary message.  This is useful for sending binary blobs, e.g.</span><span>
</span><span id="line-353"></span><span class="hs-comment">-- images, data encoded with MessagePack, images...</span><span>
</span><span id="line-354"></span><span id="local-6989586621679079349"><span class="annot"><a href="Network.WebSockets.Connection.html#sendBinaryData"><span class="hs-identifier hs-type">sendBinaryData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079349"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079349"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-355"></span><span id="sendBinaryData"><span class="annot"><span class="annottext">sendBinaryData :: forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendBinaryData"><span class="hs-identifier hs-var hs-var">sendBinaryData</span></a></span></span><span> </span><span id="local-6989586621679079353"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079353"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; [a] -&gt; IO ()
forall a. WebSocketsData a =&gt; Connection -&gt; [a] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendBinaryDatas"><span class="hs-identifier hs-var">sendBinaryDatas</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079353"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([a] -&gt; IO ()) -&gt; (a -&gt; [a]) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a]
forall a. a -&gt; [a]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- | Send a number of binary messages.  This is more efficient than calling</span><span>
</span><span id="line-359"></span><span class="hs-comment">-- 'sendBinaryData' many times.</span><span>
</span><span id="line-360"></span><span id="local-6989586621679079354"><span class="annot"><a href="Network.WebSockets.Connection.html#sendBinaryDatas"><span class="hs-identifier hs-type">sendBinaryDatas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079354"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679079354"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-361"></span><span id="sendBinaryDatas"><span class="annot"><span class="annottext">sendBinaryDatas :: forall a. WebSocketsData a =&gt; Connection -&gt; [a] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendBinaryDatas"><span class="hs-identifier hs-var hs-var">sendBinaryDatas</span></a></span></span><span> </span><span id="local-6989586621679079357"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079357"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; [DataMessage] -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendDataMessages"><span class="hs-identifier hs-var">sendDataMessages</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079357"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">([DataMessage] -&gt; IO ()) -&gt; ([a] -&gt; [DataMessage]) -&gt; [a] -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; DataMessage) -&gt; [a] -&gt; [DataMessage]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; DataMessage
</span><a href="Network.WebSockets.Types.html#Binary"><span class="hs-identifier hs-var">Binary</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; DataMessage)
-&gt; (a -&gt; ByteString) -&gt; a -&gt; DataMessage
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. WebSocketsData a =&gt; a -&gt; ByteString
</span><a href="Network.WebSockets.Types.html#toLazyByteString"><span class="hs-identifier hs-var">toLazyByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- | Send a friendly close message.  Note that after sending this message,</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- you should still continue calling 'receiveDataMessage' to process any</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- in-flight messages.  The peer will eventually respond with a close control</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- message of its own which will cause 'receiveDataMessage' to throw the</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- 'CloseRequest' exception.  This exception is when you can finally consider</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- the connection closed.</span><span>
</span><span id="line-370"></span><span id="local-6989586621679079359"><span class="annot"><a href="Network.WebSockets.Connection.html#sendClose"><span class="hs-identifier hs-type">sendClose</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079359"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079359"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-371"></span><span id="sendClose"><span class="annot"><span class="annottext">sendClose :: forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendClose"><span class="hs-identifier hs-var hs-var">sendClose</span></a></span></span><span> </span><span id="local-6989586621679079364"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079364"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Word16 -&gt; a -&gt; IO ()
forall a. WebSocketsData a =&gt; Connection -&gt; Word16 -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendCloseCode"><span class="hs-identifier hs-var">sendCloseCode</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079364"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- | Send a friendly close message and close code.  Similar to 'sendClose',</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- you should continue calling 'receiveDataMessage' until you receive a</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- 'CloseRequest' exception.</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- See &lt;http://tools.ietf.org/html/rfc6455#section-7.4&gt; for a list of close</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- codes.</span><span>
</span><span id="line-381"></span><span id="local-6989586621679079078"><span class="annot"><a href="Network.WebSockets.Connection.html#sendCloseCode"><span class="hs-identifier hs-type">sendCloseCode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079078"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word16</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079078"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-382"></span><span id="sendCloseCode"><span class="annot"><span class="annottext">sendCloseCode :: forall a. WebSocketsData a =&gt; Connection -&gt; Word16 -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendCloseCode"><span class="hs-identifier hs-var hs-var">sendCloseCode</span></a></span></span><span> </span><span id="local-6989586621679079367"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079367"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621679079368"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679079368"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Message -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079367"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; IO ()) -&gt; (a -&gt; Message) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; Message
</span><a href="Network.WebSockets.Types.html#ControlMessage"><span class="hs-identifier hs-var">ControlMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(ControlMessage -&gt; Message)
-&gt; (a -&gt; ControlMessage) -&gt; a -&gt; Message
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; ByteString -&gt; ControlMessage
</span><a href="Network.WebSockets.Types.html#Close"><span class="hs-identifier hs-var">Close</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679079368"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ControlMessage)
-&gt; (a -&gt; ByteString) -&gt; a -&gt; ControlMessage
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. WebSocketsData a =&gt; a -&gt; ByteString
</span><a href="Network.WebSockets.Types.html#toLazyByteString"><span class="hs-identifier hs-var">toLazyByteString</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-387"></span><span class="annot"><span class="hs-comment">-- | Send a ping</span></span><span>
</span><span id="line-388"></span><span id="local-6989586621679079369"><span class="annot"><a href="Network.WebSockets.Connection.html#sendPing"><span class="hs-identifier hs-type">sendPing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Types.html#WebSocketsData"><span class="hs-identifier hs-type">WebSocketsData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679079369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679079369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-389"></span><span id="sendPing"><span class="annot"><span class="annottext">sendPing :: forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendPing"><span class="hs-identifier hs-var hs-var">sendPing</span></a></span></span><span> </span><span id="local-6989586621679079372"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079372"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Message -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#send"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079372"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; IO ()) -&gt; (a -&gt; Message) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; Message
</span><a href="Network.WebSockets.Types.html#ControlMessage"><span class="hs-identifier hs-var">ControlMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(ControlMessage -&gt; Message)
-&gt; (a -&gt; ControlMessage) -&gt; a -&gt; Message
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ControlMessage
</span><a href="Network.WebSockets.Types.html#Ping"><span class="hs-identifier hs-var">Ping</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ControlMessage)
-&gt; (a -&gt; ByteString) -&gt; a -&gt; ControlMessage
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. WebSocketsData a =&gt; a -&gt; ByteString
</span><a href="Network.WebSockets.Types.html#toLazyByteString"><span class="hs-identifier hs-var">toLazyByteString</span></a></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- | Forks a ping thread, sending a ping message every @n@ seconds over the</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- connection.  The thread is killed when the inner IO action is finished.</span><span>
</span><span id="line-395"></span><span class="hs-comment">--</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- This is useful to keep idle connections open through proxies and whatnot.</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- Many (but not all) proxies have a 60 second default timeout, so based on that</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- sending a ping every 30 seconds is a good idea.</span><span>
</span><span id="line-399"></span><span id="local-6989586621679079081"><span class="annot"><a href="Network.WebSockets.Connection.html#withPingThread"><span class="hs-identifier hs-type">withPingThread</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Second interval in which pings should be sent.</span></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Repeat this after sending a ping.</span></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679079081"><span class="hs-identifier hs-type">a</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Application to wrap with a ping thread.</span></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679079081"><span class="hs-identifier hs-type">a</span></a></span></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Executes application and kills ping thread when done.</span></span><span>
</span><span id="line-405"></span><span id="withPingThread"><span class="annot"><span class="annottext">withPingThread :: forall a. Connection -&gt; Int -&gt; IO () -&gt; IO a -&gt; IO a
</span><a href="Network.WebSockets.Connection.html#withPingThread"><span class="hs-identifier hs-var hs-var">withPingThread</span></a></span></span><span> </span><span id="local-6989586621679079373"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079373"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621679079374"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079374"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679079375"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679079375"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679079376"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679079376"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; (Async () -&gt; IO a) -&gt; IO a
forall a b. IO a -&gt; (Async a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; Int -&gt; IO () -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#pingThread"><span class="hs-identifier hs-var">pingThread</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079373"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079374"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679079375"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679079376"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-410"></span><span class="hs-comment">-- | DEPRECATED: Use 'withPingThread' instead.</span><span>
</span><span id="line-411"></span><span class="hs-comment">--</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- Forks a ping thread, sending a ping message every @n@ seconds over the</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- connection.  The thread dies silently if the connection crashes or is closed.</span><span>
</span><span id="line-414"></span><span class="hs-comment">--</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- This is useful to keep idle connections open through proxies and whatnot.</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- Many (but not all) proxies have a 60 second default timeout, so based on that</span><span>
</span><span id="line-417"></span><span class="hs-comment">-- sending a ping every 30 seconds is a good idea.</span><span>
</span><span id="line-418"></span><span class="annot"><a href="Network.WebSockets.Connection.html#forkPingThread"><span class="hs-identifier hs-type">forkPingThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span id="forkPingThread"><span class="annot"><span class="annottext">forkPingThread :: Connection -&gt; Int -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#forkPingThread"><span class="hs-identifier hs-var hs-var">forkPingThread</span></a></span></span><span> </span><span id="local-6989586621679079378"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079378"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621679079379"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079379"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Int -&gt; IO () -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#pingThread"><span class="hs-identifier hs-var">pingThread</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079378"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079379"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">forkPingThread</span><span> </span><span class="hs-pragma">&quot;Use 'withPingThread' instead&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- | Use this if you want to run the ping thread yourself.</span><span>
</span><span id="line-427"></span><span class="hs-comment">--</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- See also 'withPingThread'.</span><span>
</span><span id="line-429"></span><span class="annot"><a href="Network.WebSockets.Connection.html#pingThread"><span class="hs-identifier hs-type">pingThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.WebSockets.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span id="pingThread"><span class="annot"><span class="annottext">pingThread :: Connection -&gt; Int -&gt; IO () -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#pingThread"><span class="hs-identifier hs-var hs-var">pingThread</span></a></span></span><span> </span><span id="local-6989586621679079380"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079380"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621679079381"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079381"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679079382"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679079382"><span class="hs-identifier hs-var">action</span></a></span></span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079381"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO ()
</span><a href="#local-6989586621679079384"><span class="hs-identifier hs-var">ignore</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
</span><span class="hs-operator hs-var">`handle`</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679079385"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><a href="#local-6989586621679079385"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>    </span><span id="local-6989586621679079385"><span class="annot"><span class="annottext">go :: Int -&gt; IO ()
</span><a href="#local-6989586621679079385"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679079386"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079386"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079381"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Text -&gt; IO ()
forall a. WebSocketsData a =&gt; Connection -&gt; a -&gt; IO ()
</span><a href="Network.WebSockets.Connection.html#sendPing"><span class="hs-identifier hs-var">sendPing</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679079380"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079386"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679079382"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-439"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679079385"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679079386"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621679079384"><span class="annot"><span class="annottext">ignore :: SomeException -&gt; IO ()
</span><a href="#local-6989586621679079384"><span class="hs-identifier hs-var hs-var">ignore</span></a></span></span><span> </span><span id="local-6989586621679079395"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679079395"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679079395"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-442"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679079396"><span class="annot"><span class="annottext">AsyncException
</span><a href="#local-6989586621679079396"><span class="hs-identifier hs-var">async</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AsyncException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AsyncException
</span><a href="#local-6989586621679079396"><span class="hs-identifier hs-var">async</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AsyncException</span></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><span class="annottext">Maybe AsyncException
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span></pre></body></html>